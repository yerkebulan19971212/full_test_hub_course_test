<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Authentication</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0088cc 0%, #00a8e6 100%);
            padding: 40px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px;
        }

        .auth-section {
            display: block;
        }

        .auth-section.hidden {
            display: none;
        }

        .telegram-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .telegram-btn:hover {
            background: #0077b5;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 136, 204, 0.3);
        }

        .telegram-btn:active {
            transform: translateY(0);
        }

        .telegram-icon {
            width: 24px;
            height: 24px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .user-profile {
            text-align: center;
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            border: 4px solid #0088cc;
        }

        .user-info {
            margin-bottom: 24px;
        }

        .user-info h2 {
            color: #333;
            margin-bottom: 8px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
        }

        .token-section {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .token-section h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .token-text {
            background: white;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            color: #333;
            max-height: 100px;
            overflow-y: auto;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0088cc;
            padding: 16px;
            margin-top: 20px;
            border-radius: 4px;
        }

        .info-box p {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .info-box strong {
            color: #0088cc;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ðŸš€ Welcome</h1>
        <p>Sign in with your Telegram account</p>
    </div>

    <div class="content">
        <!-- Login Section -->
        <div id="loginSection" class="auth-section">
            <button id="telegramLoginBtn" class="telegram-btn">
                <svg class="telegram-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
                </svg>
                Sign in with Telegram
            </button>

            <div class="info-box">
                <p><strong>Important:</strong> Replace <code>YOUR_BOT_USERNAME</code> in the script below with your
                    actual bot username, and update the API endpoint URL to your Django backend.</p>
            </div>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="auth-section hidden">
            <div class="loading">
                <div class="spinner"></div>
                <p>Authenticating...</p>
            </div>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="auth-section hidden">
            <div class="error-message" id="errorMessage"></div>
            <button class="telegram-btn" onclick="resetAuth()">Try Again</button>
        </div>

        <!-- User Profile Section -->
        <div id="profileSection" class="auth-section hidden">
            <div class="user-profile">
                <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">

                <div class="user-info">
                    <h2 id="userName">Loading...</h2>
                    <p id="userUsername"></p>
                </div>

                <div class="token-section">
                    <h3>Access Token:</h3>
                    <div class="token-text" id="accessToken"></div>
                </div>

                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>
</div>

<!-- Telegram Widget Script -->
<script async src="https://telegram.org/js/telegram-widget.js?22"
        data-telegram-login="testup1bot"
        data-size="large"
        data-onauth="onTelegramAuth(user)"
        data-request-access="write"
        style="display: none;">
</script>

<script>
    // Configuration - UPDATE THESE VALUES
    const API_ENDPOINT = 'https://api.testhub.kz/accounts/api/v1/auth/telegram/'; // Change to your Django API URL
    const BOT_USERNAME = 'testup1bot'; // Change to your bot username

    // Check if user is already logged in
    window.addEventListener('DOMContentLoaded', () => {
        checkExistingAuth();
    });

    function checkExistingAuth() {
        const accessToken = localStorage.getItem('access_token');
        const userData = localStorage.getItem('user_data');

        if (accessToken && userData) {
            showProfile(JSON.parse(userData), accessToken);
        }
    }

    // Telegram Login Button Click Handler
    document.getElementById('telegramLoginBtn').addEventListener('click', function () {
        // Trigger the hidden Telegram widget
        const script = document.querySelector('script[data-telegram-login]');
        if (script) {
            // Create a temporary container for the widget
            const container = document.createElement('div');
            container.style.display = 'none';
            document.body.appendChild(container);

            // Clone and re-add the script to trigger it
            const newScript = document.createElement('script');
            newScript.src = 'https://telegram.org/js/telegram-widget.js?22';
            newScript.setAttribute('data-telegram-login', BOT_USERNAME);
            newScript.setAttribute('data-size', 'large');
            newScript.setAttribute('data-onauth', 'onTelegramAuth(user)');
            newScript.setAttribute('data-request-access', 'write');
            container.appendChild(newScript);

            // Simulate click on the widget after it loads
            setTimeout(() => {
                const iframe = container.querySelector('iframe');
                if (iframe) {
                    // Open Telegram auth in new window
                    const authUrl = `https://oauth.telegram.org/auth?bot_id=YOUR_BOT_ID&origin=${encodeURIComponent(window.location.origin)}&request_access=write`;
                    window.open(authUrl, 'telegram-auth', 'width=550,height=470');
                }
            }, 500);
        } else {
            showError('Telegram widget not configured properly. Please update BOT_USERNAME in the HTML.');
        }
    });

    // This function is called by Telegram widget after successful authentication
    function onTelegramAuth(user) {
        console.log('Telegram auth data:', user);
        showLoading();
        authenticateWithBackend(user);
    }

    async function authenticateWithBackend(telegramData) {
        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(telegramData)
            });

            if (response.ok) {
                const data = await response.json();

                // Store tokens and user data
                localStorage.setItem('access_token', data.access);
                localStorage.setItem('refresh_token', data.refresh);
                localStorage.setItem('user_data', JSON.stringify(data.user));

                showProfile(data.user, data.access);
            } else {
                const errorData = await response.json();
                showError(errorData.error || 'Authentication failed. Please try again.');
            }
        } catch (error) {
            console.error('Authentication error:', error);
            showError('Network error. Please check your connection and try again.');
        }
    }

    function showLoading() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('errorSection').classList.add('hidden');
        document.getElementById('profileSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.remove('hidden');
    }

    function showError(message) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('profileSection').classList.add('hidden');
        document.getElementById('errorSection').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = message;
    }

    function showProfile(user, accessToken) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('errorSection').classList.add('hidden');
        document.getElementById('profileSection').classList.remove('hidden');

        // Update profile UI
        const userName = user.first_name_telegram || user.username_telegram || 'Telegram User';
        const userUsername = user.username_telegram ? `@${user.username_telegram}` : `ID: ${user.telegram_id}`;
        const userAvatar = user.photo_url || 'https://via.placeholder.com/100?text=User';

        document.getElementById('userName').textContent = userName;
        document.getElementById('userUsername').textContent = userUsername;
        document.getElementById('userAvatar').src = userAvatar;
        document.getElementById('accessToken').textContent = accessToken;
    }

    function resetAuth() {
        document.getElementById('loginSection').classList.remove('hidden');
        document.getElementById('errorSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('profileSection').classList.add('hidden');
    }

    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        localStorage.removeItem('user_data');
        resetAuth();
    }

    // Example: Making authenticated API requests
    async function makeAuthenticatedRequest(endpoint) {
        const token = localStorage.getItem('access_token');

        try {
            const response = await fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });

            if (response.status === 401) {
                // Token expired, try to refresh
                await refreshToken();
                // Retry the request
                return makeAuthenticatedRequest(endpoint);
            }

            return await response.json();
        } catch (error) {
            console.error('Request error:', error);
            throw error;
        }
    }

    async function refreshToken() {
        const refreshToken = localStorage.getItem('refresh_token');

        try {
            const response = await fetch('http://localhost:8000/api/auth/token/refresh/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({refresh: refreshToken})
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('access_token', data.access);
            } else {
                // Refresh failed, logout user
                logout();
                throw new Error('Session expired. Please login again.');
            }
        } catch (error) {
            logout();
            throw error;
        }
    }
</script>
</body>
</html>